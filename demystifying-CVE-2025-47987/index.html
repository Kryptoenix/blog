<!doctype html>
<html lang="en-US">
  <head prefix="og: https://ogp.me/ns#">
    <meta charset="utf-8" />
    <meta name="generator" content="gh:importantimport/urara" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" crossorigin="use-credentials" href="/blog/manifest.webmanifest" />
    <link rel="alternate" type="application/feed+json" href="/blog/feed.json" />
    <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" />
    <link rel="sitemap" type="application/xml" href="/blog/sitemap.xml" />
    <meta http-equiv="content-security-policy" content="style-src 'self' 'unsafe-inline' https://giscus.app">
		<link href="../_app/immutable/assets/0.ws8ONPyK.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.5BFxfmEv.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CIXkrfj9.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C3_DH_NE.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C6P1_ZWx.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.CWN9j8t8.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C1FmrZbK.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/IHki7fMi.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.C9lfkJNS.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/5Gp7X5ME.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BXRl7WPX.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.GJ3g4Gva.js"><title>Demystifying CVE-2025-47987 | Kryptoenix</title><!-- HEAD_svelte-1laq3tv_START --><link href="https://github.com/Kryptoenix" rel="me"><link href="https://webmention.io/Kryptoenix/webmention" rel="webmention"> <link href="https://webmention.io/Kryptoenix/xmlrpc" rel="pingback"><!-- HEAD_svelte-1laq3tv_END --><!-- HEAD_svelte-10yve3l_START --><link href="https://localhost:5173/blog/favicon.png" rel="shortcut icon" sizes="48x48" type="image/png"><link href="https://localhost:5173/blog/assets/kryptoenix.png" rel="apple-touch-icon" sizes="180x180" type="image/png"><link href="https://localhost:5173/blog/assets/kryptoenix.png" rel="icon" sizes="192x192" type="image/png"><!-- HEAD_svelte-10yve3l_END --><!-- HEAD_svelte-yn0p46_START --><meta name="theme-color"><!-- HEAD_svelte-yn0p46_END --><!-- HEAD_svelte-13ashyv_START --><meta content="Kryptoenix" name="author"><link href="https://localhost:5173/blog/blog/demystifying-CVE-2025-47987" rel="canonical">  <meta content="CVE-2025-47987, Reverse Engineering, Windows" name="keywords"> <!-- HTML_TAG_START --><link rel="authorization_endpoint" href="https://indieauth.com/auth"><!-- HTML_TAG_END --><!-- HTML_TAG_START --><link rel="token_endpoint" href="https://tokens.indieauth.com/token"><!-- HTML_TAG_END --><!-- HEAD_svelte-13ashyv_END --><!-- HEAD_svelte-1b7xa4j_START --><meta content="Kryptoenix" property="og:site_name"><meta content="en-US" property="og:locale"><meta content="article" property="og:type"> <meta content="Demystifying CVE-2025-47987" property="og:title">  <meta content="https://localhost:5173/blog/demystifying-CVE-2025-47987/image-cve1.png" property="og:image"> <meta content="summary_large_image" name="twitter:card"> <meta content="CVE-2025-47987" property="article:tag"><meta content="Reverse Engineering" property="article:tag"><meta content="Windows" property="article:tag"> <meta content="https://localhost:5173/blog/blog/demystifying-CVE-2025-47987" property="og:url"> <meta content="Kryptoenix" property="article:author"> <meta content="2025-07-10T00:00:00.000Z" property="article:published_time"> <meta content="2025-07-10T00:00:00.000Z" property="article:modified_time"><!-- HEAD_svelte-1b7xa4j_END -->
  </head>
  <body itemscope itemtype="https://schema.org/WebPage">
    <div style="display: contents">      <header class="fixed z-50 w-full transition-all duration-500 ease-in-out border-b-2 border-transparent max-h-[4.125rem]false" id="header"><div class="navbar"><div class="navbar-start">  <div class="dropdown lg:hidden"><label class="btn btn-square btn-ghost" for="navbar-dropdown" tabindex="0" data-svelte-h="svelte-18njhny"><span class="i-heroicons-outline-menu-alt-1"></span></label> <ul class="menu menu-compact dropdown-content bg-base-100 text-base-content shadow-lg rounded-box min-w-max max-w-52 p-2" id="navbar-dropdown" tabindex="0"><li><a href="/blog/about">About</a> </li></ul></div> <div class="swap order-last hidden lg:inline-grid"><button class="swap-on btn btn-ghost text-base font-normal normal-case transition-all duration-200 hidden"></button> <ul class="swap-off menu menu-horizontal p-0"><li><a class="!rounded-btn" href="/blog/about">About</a> </li></ul></div> <a class="btn btn-ghost normal-case text-lg" href="/blog">Kryptoenix</a></div> <div class="navbar-end"><button aria-label="search" class="btn btn-square btn-ghost" tabindex="0" data-svelte-h="svelte-17v5buh"><span class="i-heroicons-outline-search"></span></button> <div class="dropdown dropdown-end" id="change-theme">  <div class="btn btn-square btn-ghost" tabindex="0" data-svelte-h="svelte-1xk2wyd"><span class="i-heroicons-outline-color-swatch"></span></div>   <ul class="flex flex-nowrap shadow-2xl menu dropdown-content bg-base-100 text-base-content rounded-box w-52 p-2 gap-2 overflow-y-auto max-h-[21.5rem]" tabindex="0"><button class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all" data-theme="forest"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">🌲 Forest</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all" data-theme="cmyk"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">🖨 Light</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all" data-theme="dracula"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">🧛 Dark</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all" data-theme="synthwave"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">🌃 Synthwave</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button></ul></div></div></div></header> <button aria-label="scroll to top" class="fixed grid group btn btn-circle btn-lg border-none backdrop-blur bottom-6 right-6 z-50 duration-500 ease-in-outbtn-ghost bg-base-100/30 md:bg-base-200/30  translate-y-24" id="totop"> <div class="radial-progress text-accent transition-all duration-500 ease-in-out group-hover:text-[color-mix(in_oklab,oklch(var(--a)),black_7%)] col-start-1 row-start-1" style="--size:4rem; --thickness: 0.25rem; --value:undefined;"></div> <div class="border-4 border-base-content/10 group-hover:border-transparent col-start-1 row-start-1 rounded-full w-full h-full p-4 grid duration-500 ease-in-out" data-svelte-h="svelte-1lpt3af"><span class="i-heroicons-solid-chevron-up !w-6 !h-6"></span></div></button> <div class="bg-base-100 md:bg-base-200 min-h-screen pt-16 md:pb-8 lg:pb-16">  <div class="flex flex-col flex-nowrap justify-center xl:flex-row xl:flex-wrap"><div class="flex-1 w-full order-first ease-out transform mx-auto xl:mr-0 xl:ml-0"></div> <div class="flex-1 w-full xl:order-last ease-out transform mx-auto xl:ml-0 xl:mr-0"></div> <div class="flex-none w-full max-w-screen-md mx-auto xl:mx-0"><article itemscope itemtype="https://schema.org/BlogPosting" itemprop="blogPost" class="h-entry card bg-base-100 rounded-none md:rounded-box md:shadow-lg md:shadow-grey-10 overflow-hidden z-10 md:mb-8 lg:mb-16"><div id="bridgy" class="hidden"><a href="https://brid.gy/publish/mastodon">mastodon</a></div>   <div class="card-body gap-0 "><div class="flex flex-col gap-2"><figure class="md:order-last rounded-lg mb-4 flex-col gap-2 -mt-8 md:mt-0'
          }"><picture><source srcset="/blog/_app/immutable/assets/image-cve1.DWv_BxEm.avif 736w" type="image/avif"> <img alt="/demystifying-CVE-2025-47987/image-cve1.png" class="u-featured" decoding="async" loading="lazy" src="/demystifying-CVE-2025-47987/image-cve1.png"></picture></figure> <div class="flex font-semibold gap-1.5"><a class="opacity-75 hover:opacity-100 hover:text-primary duration-500 ease-in-out p-author h-card" href="https://localhost:5173/blog" rel="author">Kryptoenix</a> <span class="opacity-50" data-svelte-h="svelte-1ijzl0g">/</span> <a class="u-url u-uid swap group/time" href="/blog/demystifying-CVE-2025-47987"><time class="group-hover/time:opacity-0 font-semibold opacity-75 duration-500 ease-in-out mr-auto dt-published" datetime="2025-07-10T00:00:00.000Z" itemprop="datePublished">Thursday, Jul 10, 25</time> <time class="opacity-0 group-hover/time:opacity-100 font-semibold text-primary duration-500 ease-in-out mr-auto dt-updated" datetime="2025-07-10T00:00:00.000Z" itemprop="dateModified">Thursday, Jul 10, 25</time></a></div> <h1 itemprop="name headline" class="card-title text-2xl mb-8 p-name">Demystifying CVE-2025-47987</h1> </div> <main itemprop="articleBody" class="urara-prose prose e-content"><p data-svelte-h="svelte-1cf6xwb">Hello reader, this blog post will be about a vulnerability in Windows which was publicly announced last month as part of the  July 8th patch update. The vulnerable component is part of the client authentication mechanism. To begin, let’s take a high-level look at how this component works.</p> <h2 id="client-authentication-architecture" data-svelte-h="svelte-daz9pc"><a href="#client-authentication-architecture">Client Authentication Architecture</a></h2> <p data-svelte-h="svelte-1ivkzmk">In Windows, the authentication happens in 2 layers, user-mode and kernel-mode.</p> <div class="overflow-x-auto mb-4"><table class="table w-full"><thead data-svelte-h="svelte-1wvqf93"><tr><th><strong><em>User-mode</em></strong></th> <th><strong><em>Kernel-mode</em></strong></th></tr></thead> <tbody data-svelte-h="svelte-1f0pijk"><tr><td>The <strong>Local Security Authority</strong> (LSA/lsass.exe) is a user-mode process that acts as a security policy enforcer. It receives credentials from Winlogon or Credential Provider, packages them and sends them to the appropriate authentication package(e.g Kerberos, NTLM) in kernel-mode. It also ensures that the credential format is correct before passing it down.</td> <td>In kernel, credentials are validated by the Kerberos, NTLM or other authentication providers. The actual validation (e.g. ticket generation, password hashing) is done here.</td></tr></tbody></table></div> <p><picture><source srcset="/blog/_app/immutable/assets/authn_lsa_architecture_client.DU47lAom.avif 736w" type="image/avif"> <img alt="/demystifying-CVE-2025-47987/authn_lsa_architecture_client.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="/demystifying-CVE-2025-47987/authn_lsa_architecture_client.png"></picture></p> <p data-svelte-h="svelte-7tfvlj">The <strong>CredSSP</strong> protocol is part of this authentication architecture and allows applications to securely delegate user credentials from a client to a server for remote authentication.
For example, RDP protocol uses <strong>CredSSP</strong> protocol for preparing the client-supplied credentials when authenticating to a server, as seen in the image below (first stage). This aspect of the authentication flow will be important when discussing the vulnerability details.</p> <p><picture><source srcset="/blog/_app/immutable/assets/credssp_rdp.jqnvWuA6.avif 736w" type="image/avif"> <img alt="/demystifying-CVE-2025-47987/credssp_rdp.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="/demystifying-CVE-2025-47987/credssp_rdp.png"></picture></p> <h2 id="root-cause" data-svelte-h="svelte-c8o2ov"><a href="#root-cause">Root Cause</a></h2> <p data-svelte-h="svelte-17i75gr">According to <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-47987%E2%80%8B" rel="nofollow noopener noreferrer external" target="_blank">Microsoft update website</a>, the vulnerability results from a chain of 2 bugs:</p> <ul data-svelte-h="svelte-vkq1gg"><li>Integer overflow</li> <li>Heap-based buffer overflow</li></ul> <p data-svelte-h="svelte-90nf04">Microsoft also mentions that the weakness resides in a component which is part of the CredSSP protocol. Through patch diffing technique, an interesting finding was observed in the <code>tspkg.dll</code> driver. The full module name is <strong>Terminal Services Security Package</strong> and it implements the <strong>TS(Terminal Services)</strong> authentication protocol, which is used for RDP authentication.
This driver is a suitable candidate for this CVE because it is used to prepare the RDP credentials before sending them to the server.</p> <div class="alert flex-col shadow-inner my-4  alert-info"><div class="mr-auto flex items-center space-x-3"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24 text-black-500"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 9h.008v.008H11.25V9zm.75 4.5v3.75m0-12a9 9 0 100 18 9 9 0 000-18z"></path></svg> <div><div style="font-size: 20px;" class="font-bold">Tip</div> <div style="font-size: 16px;" class="text-xs">Usually, a faster route to identify the vulnerable driver is by extracting the drivers associated with the patch update (KB number), but recently, Microsoft changed the update file format and the extraction of its associated system files became harder.</div></div></div> </div> <p data-svelte-h="svelte-1lvm5qv">This is the interesting function:</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" c="true"><div class="language-id">c</div><div class='code-container'><code><div class='line dim'><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> __fastcall </span><span style="color: #A6E22E">TSCreateKerbCertLogonBuffer</span><span style="color: #F8F8F2">(</span></div><div class='line dim'><span style="color: #F8F8F2">    UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">password</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">domain</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">username</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">a4</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">size_t</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">certLen</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">**</span><span style="color: #FD971F">a6</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">a7</span><span style="color: #F8F8F2">)</span></div><div class='line dim'><span style="color: #F8F8F2">&#123;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> totalLength;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> alignedTotalLength;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> __totalLength;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> _Size;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">size_t</span><span style="color: #F8F8F2"> _totalLength;</span></div><div class='line dim'><span style="color: #F8F8F2">    ... </span><span style="color: #88846F">// other variables declaration</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Initial setup</span></div><div class='line dim'><span style="color: #F8F8F2">    src </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> a4;</span></div><div class='line dim'><span style="color: #F8F8F2">    totalLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (domain-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> password-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> username-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">93</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">FFFFFFF8</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    _totalLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> totalLength;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    _Size </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> certLen;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Feature flag check</span></div><div class='line highlight'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (isEnabled)</span></div><div class='line highlight'><span style="color: #F8F8F2">    &#123;</span></div><div class='line highlight'><span style="color: #F8F8F2">        status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">RtlULongAdd</span><span style="color: #F8F8F2">(totalLength, certLen, (</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)</span><span style="color: #F92672">&</span><span style="color: #F8F8F2">_totalLength);</span></div><div class='line highlight'><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (status </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">)</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2">)status;</span></div><div class='line'></div><div class='line highlight'><span style="color: #F8F8F2">        __totalLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2">)_totalLength;</span></div><div class='line highlight'><span style="color: #F8F8F2">    &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">else</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">        __totalLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> totalLength </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> certLen;</span></div><div class='line dim'><span style="color: #F8F8F2">    &#125;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Allocate memory for the buffer</span></div><div class='line dim'><span style="color: #F8F8F2">    buff </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSAllocate</span><span style="color: #F8F8F2">(__totalLength);</span></div><div class='line dim'><span style="color: #F8F8F2">    _buff </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> buff;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (</span><span style="color: #F92672">!</span><span style="color: #F8F8F2">buff)</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000009A</span><span style="color: #F8F8F2">;   </span><span style="color: #88846F">// STATUS_INSUFFICIENT_RESOURCES</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Fill in header</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)buff </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">13</span><span style="color: #F8F8F2">;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    currentPtr   </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">80</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    passwordBuf  </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">void</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">80</span><span style="color: #F8F8F2">);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Password</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">40</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> password-&gt;Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    length </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> password-&gt;Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(QWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">48</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">80</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">42</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(passwordBuf, password-&gt;Buffer, password-&gt;Length);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Domain</span></div><div class='line dim'><span style="color: #F8F8F2">    domainBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">short</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">42</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> currentPtr);</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">8</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> domain-&gt;Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">10</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> domain-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(QWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">16</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">domainBuf[</span><span style="color: #F92672">-</span><span style="color: #F8F8F2">_buff];</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(domainBuf, domain-&gt;Buffer, domain-&gt;Length);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Username</span></div><div class='line dim'><span style="color: #F8F8F2">    usernameBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">domainBuf[</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">short</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">10</span><span style="color: #F8F8F2">)];</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">24</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> username-&gt;Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">26</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> username-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(QWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">32</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">usernameBuf[</span><span style="color: #F92672">-</span><span style="color: #F8F8F2">_buff];</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(usernameBuf, username-&gt;Buffer, username-&gt;Length);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Certificate</span></div><div class='line dim'><span style="color: #F8F8F2">    certBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(</span></div><div class='line dim'><span style="color: #F8F8F2">        (</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2">)</span><span style="color: #F92672">&</span><span style="color: #F8F8F2">usernameBuf[</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">short</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">26</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">7</span><span style="color: #F8F8F2">]</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">FFFFFFFFFFFFFFF8</span><span style="color: #F92672">ULL</span></div><div class='line dim'><span style="color: #F8F8F2">    );</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">60</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> _Size;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(QWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_buff </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">64</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">certBuf[</span><span style="color: #F92672">-</span><span style="color: #F8F8F2">_buff];</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(certBuf, src, _Size);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Output</span></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> status;</span></div><div class='line dim'><span style="color: #F8F8F2">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-qoeirs">The highlighted section shows the patched code. The use of the <code>RtlULongAdd</code> function strongly suggests that the original, vulnerable version was susceptible to integer overflow. Later in the function, the result of this calculation, potentially overflowed, is used to allocate a heap object and perform copy operations, which could lead to buffer overflow. It is safe to assume that this is the vulnerable function since it matches the MS description for CVE-2025-47987.</p> <h2 id="building-a-poc-crash" data-svelte-h="svelte-1y92owq"><a href="#building-a-poc-crash">Building a PoC Crash</a></h2> <p data-svelte-h="svelte-akc3jh">In order to identify the entry point into the <code>tspkg.dll</code> driver, a good approach is to start from the vulnerable function and trace back the function from which it was called. Then, repeat the same step up until the entry function is reached inside the driver. This is the list of functions which are the most relevant for the vulnerability:</p> <ul data-svelte-h="svelte-1rmq3os"><li><code>SpAcquireCredentialsHandle</code> <ul><li><code>TSCaptureSuppliedCreds</code></li> <li><code>TSUnpackKerbCertLogonBuffer</code> <ul><li><code>TSInitCertCreds</code> <ul><li><code>TSGetCspDetailFromCspData</code> <ul><li><code>TSRelocateCspString</code></li></ul></li> <li><strong>TSCreateKerbCertLogonBuffer</strong></li></ul></li></ul></li></ul></li></ul> <p data-svelte-h="svelte-1sg7tlg">When the PoC binary calls the <code>AcquireCredentialsHandle</code> WinAPI function, the SSPI module forwards the request to the <code>lsass.exe</code> process. <code>lsass.exe</code> then routes the request to the appropriate security package driver—in this case, <code>tspkg.dll</code>—where the <code>SpAcquireCredentialsHandle</code> function is invoked. The credential flow for a RDP connection where <code>tspkg.dll</code> is invoked can be seen in the image below.</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" bash="true"><div class="language-id">bash</div><div class='code-container'><code><div class='line'><span style="color: #F8F8F2">RDP Client</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">|</span></div><div class='line'><span style="color: #F8F8F2">    v</span></div><div class='line'><span style="color: #F8F8F2">Terminal Services Service (calls SSPI with </span><span style="color: #E6DB74">"TSSSP"</span><span style="color: #F8F8F2">)</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">|</span></div><div class='line'><span style="color: #F8F8F2">    v</span></div><div class='line'><span style="color: #F8F8F2">SSPI </span><span style="color: #E6DB74">"TSSSP"</span><span style="color: #F8F8F2"> package (user mode)</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">|</span></div><div class='line'><span style="color: #F8F8F2">    v</span></div><div class='line'><span style="color: #F8F8F2">Communicates with LSASS process</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">|</span></div><div class='line'><span style="color: #F8F8F2">    v</span></div><div class='line'><span style="color: #F8F8F2">LSASS dispatches to LSA package </span><span style="color: #E6DB74">"tspkg.dll"</span><span style="color: #F8F8F2"> (SpAcquireCredentialsHandle)</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">|</span></div><div class='line'><span style="color: #F8F8F2">    v</span></div><div class='line'><span style="color: #E6DB74">&#96;tspkg.dll&#96;</span><span style="color: #F8F8F2"> handles credentials inside LSASS (SYSTEM)</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">|</span></div><div class='line'><span style="color: #F8F8F2">    v</span></div><div class='line'><span style="color: #F8F8F2">RDP session proceeds</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-nfgyqs">The Poc binary calls <code>AcquireCredentialsHandle</code> with the following parameters:</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" c="true"><div class="language-id">c</div><div class='code-container'><code><div class='line'><span style="color: #A6E22E">AcquireCredentialHandleW</span><span style="color: #F8F8F2">(</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #AE81FF">NULL</span><span style="color: #F8F8F2">,</span></div><div class='line'><span style="color: #F8F8F2">    (LPWSTR)L</span><span style="color: #E6DB74">"TSSSP"</span><span style="color: #F8F8F2">,   </span><span style="color: #88846F">// pszPackage (name of the security package)</span></div><div class='line'><span style="color: #F8F8F2">    SECPKG_CRED_OUTBOUND,</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #AE81FF">NULL</span><span style="color: #F8F8F2">,</span></div><div class='line'><span style="color: #F8F8F2">    buf,                </span><span style="color: #88846F">// pAuthData (pointer to authentication data)</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #AE81FF">NULL</span><span style="color: #F8F8F2">,</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #AE81FF">NULL</span><span style="color: #F8F8F2">,</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">&</span><span style="color: #FD971F">credHandle</span><span style="color: #F8F8F2">,</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">expiry</span></div><div class='line'><span style="color: #F8F8F2">);</span></div></code></div></pre><!-- HTML_TAG_END --> <h3 id="reaching-tsinitcertcreds" data-svelte-h="svelte-16zgcb2"><a href="#reaching-tsinitcertcreds">Reaching TSInitCertCreds()</a></h3> <p data-svelte-h="svelte-1mrsvoo">Inside <code>tspkg.dll</code>, <code>SpAcquireCredentialsHandle</code> function will call <code>TSCaptureSuppliedCreds</code> without any restrictions for the user-supplied buffer. When trying to reach <code>TSInitCertCreds</code>, there are some validations to ensure that the credential buffer received follows a required format.</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" c="true"><div class="language-id">c</div><div class='code-container'><code><div class='line dim'><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> __fastcall </span><span style="color: #A6E22E">TSCaptureSuppliedCreds</span><span style="color: #F8F8F2">(</span></div><div class='line dim'><span style="color: #F8F8F2">    LUID </span><span style="color: #F92672">*</span><span style="color: #FD971F">a1</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">void</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">a2</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    TS_PRIMARY_CREDENTIAL </span><span style="color: #F92672">**</span><span style="color: #FD971F">a3</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">a4</span><span style="color: #F8F8F2">)</span></div><div class='line dim'><span style="color: #F8F8F2">&#123;</span></div><div class='line dim'><span style="color: #F8F8F2">    ... </span><span style="color: #88846F">// Variables definition</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Get LSA call info</span></div><div class='line dim'><span style="color: #F8F8F2">    ((</span><span style="color: #66D9EF">void</span><span style="color: #F8F8F2"> (__fastcall </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">))TSGlobalLsaFunctions-&gt;GetCallInfo)(v30);</span></div><div class='line dim'><span style="color: #F8F8F2">    v9 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v30[</span><span style="color: #AE81FF">8</span><span style="color: #F8F8F2">];</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">a3 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Copy logon type</span></div><div class='line dim'><span style="color: #F8F8F2">    status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> ((</span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> (__fastcall </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(QWORD, </span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF">void</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">))</span></div><div class='line dim'><span style="color: #F8F8F2">            TSGlobalLsaFunctions-&gt;CopyFromClientBuffer)(</span></div><div class='line dim'><span style="color: #F8F8F2">                </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">4</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">, </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">_type, v8);</span></div><div class='line dim'><span style="color: #F8F8F2">    ... </span><span style="color: #88846F">// Exit on error</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    type </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> _type;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    v12 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v9 </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">40</span><span style="color: #F8F8F2">;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Handle logon types</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (type </span><span style="color: #F92672">==</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #88846F">// Unpack kerberos password logon buffer</span></div><div class='line dim'><span style="color: #F8F8F2">        ...</span></div><div class='line dim'><span style="color: #F8F8F2">    &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">else</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (type </span><span style="color: #F92672">==</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">D</span><span style="color: #F8F8F2">)</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #88846F">// Unpack kerberos certificate logon buffer</span></div><div class='line highlight'><span style="color: #F8F8F2">        v16 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSUnpackKerbCertLogonBuffer</span><span style="color: #F8F8F2">(</span></div><div class='line highlight'><span style="color: #F8F8F2">            v12 </span><span style="color: #F92672">!=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">,</span></div><div class='line highlight'><span style="color: #F8F8F2">            (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)v8,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">username,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">domain,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">password,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">certData,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">certLen,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v22,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v34);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">        _certData </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> certData;</span></div><div class='line dim'><span style="color: #F8F8F2">        ... </span><span style="color: #88846F">// Cleanup on error</span></div><div class='line dim'><span style="color: #F8F8F2">        _certLen </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> certLen;</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">goto</span><span style="color: #F8F8F2"> LABEL_14;</span></div><div class='line dim'><span style="color: #F8F8F2">    &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">else</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #88846F">// Unpack auth ID logon buffer</span></div><div class='line dim'><span style="color: #F8F8F2">        ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">LABEL_14:</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Decode password secret if available</span></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">LABEL_19:</span></div><div class='line dim'><span style="color: #F8F8F2">    ... </span><span style="color: #88846F">// Certificate check in Certificate Store (not relevant)</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (pCertContext </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> _certLen)</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line highlight'><span style="color: #F8F8F2">        status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSInitCertCreds</span><span style="color: #F8F8F2">(</span></div><div class='line highlight'><span style="color: #F8F8F2">            pCertContext,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">username,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">password,</span></div><div class='line highlight'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">domain,</span></div><div class='line highlight'><span style="color: #F8F8F2">            _certData,</span></div><div class='line highlight'><span style="color: #F8F8F2">            _certLen,</span></div><div class='line highlight'><span style="color: #F8F8F2">            a3);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">LABEL_30:</span></div><div class='line dim'><span style="color: #F8F8F2">        .. </span><span style="color: #88846F">// Cleanup</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">goto</span><span style="color: #F8F8F2"> LABEL_32;</span></div><div class='line dim'><span style="color: #F8F8F2">    &#125;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">LABEL_32:</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Cleanup on failure</span></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> status;</span></div><div class='line dim'><span style="color: #F8F8F2">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1o125ol">In the second highlighted section, the code calls <code>TsInitCertCreds</code>. To reach this call, one of two conditions must be met:</p> <ul data-svelte-h="svelte-1vjqtxi"><li>A valid certificate is found in the Microsoft certificate store for the specified user, <strong>or</strong></li> <li>Custom certificate data is provided in the <strong>pAuthData user buffer</strong>.</li></ul> <p data-svelte-h="svelte-1lsc69s">The latter approach offers greater flexibility, but the custom data must first pass the validations enforced by <code>TSUnpackKerbCertLogonBuffer</code> before the <code>certData</code> and <code>certLen</code> variables are populated.</p> <h4 id="crafting-a-valid-packed-kerbcertlogonbuffer" data-svelte-h="svelte-12vgnw6"><a href="#crafting-a-valid-packed-kerbcertlogonbuffer">Crafting a valid packed KerbCertLogonBuffer</a></h4> <p data-svelte-h="svelte-si9xav"><code>TSUnpackKerbCertLogonBuffer</code> function is responsible for validating the structure of the logon buffer. Primarly, it expects 3 <code>UNICODE_STRING</code> structures as input, denoted by <strong>username</strong>, <strong>domain name</strong> and <strong>password</strong>, and 2 output arguments for the certificate data (buffer pointer and its size).</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" c="true"><div class="language-id">c</div><div class='code-container'><code><div class='line dim'><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> __fastcall </span><span style="color: #A6E22E">TSUnpackKerbCertLogonBuffer</span><span style="color: #F8F8F2">(</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">a1</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">buffer</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">__username</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">__domain</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">__password</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">**</span><span style="color: #FD971F">cert</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">certSize</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">void</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">**</span><span style="color: #FD971F">a8</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">a9</span><span style="color: #F8F8F2">)</span></div><div class='line dim'><span style="color: #F8F8F2">&#123;</span></div><div class='line dim'><span style="color: #F8F8F2">  ... </span><span style="color: #88846F">// Variables declaration and initialization</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( a1 )</span></div><div class='line dim'><span style="color: #F8F8F2">  &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line dim'><span style="color: #F8F8F2">  &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">  </span><span style="color: #F92672">else</span></div><div class='line dim'><span style="color: #F8F8F2">  &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">    status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> ((</span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> (__fastcall </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(QWORD, </span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">))TSGlobalLsaFunctions-&gt;CopyFromClientBuffer)(</span></div><div class='line dim'><span style="color: #F8F8F2">            </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">            </span><span style="color: #AE81FF">72</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">            </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v31,</span></div><div class='line dim'><span style="color: #F8F8F2">            buffer);</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line dim'><span style="color: #F8F8F2">      </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> status;</span></div><div class='line dim'><span style="color: #F8F8F2">    v14 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> cert_len;</span></div><div class='line dim'><span style="color: #F8F8F2">    domainLen </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> domain.Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    passwordLen </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> password.Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    usernameLen </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> username.Length;</span></div><div class='line dim'><span style="color: #F8F8F2">  &#125;</span></div><div class='line highlight'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( (username.Length </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">!=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> (domain.Length </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">!=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> (password.Length </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">!=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span><span style="color: #88846F">// check unicode length</span></div><div class='line highlight'><span style="color: #F8F8F2">  &#123;</span></div><div class='line highlight'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000000D</span><span style="color: #F8F8F2">;</span></div><div class='line highlight'><span style="color: #F8F8F2">  &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">  </span><span style="color: #F92672">else</span></div><div class='line dim'><span style="color: #F8F8F2">  &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">    v18 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v14 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> ((domainLen </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> passwordLen </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> usernameLen </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">7</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">FFFFFFF8</span><span style="color: #F8F8F2">);</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( v18 </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> v14 )</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">      </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C0000095</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">else</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">      v19 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v14 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> ((domainLen </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> passwordLen </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> usernameLen </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">7</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">FFFFFFF8</span><span style="color: #F8F8F2">);</span></div><div class='line dim'><span style="color: #F8F8F2">      copy_username_buf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)</span><span style="color: #A6E22E">TSAllocate</span><span style="color: #F8F8F2">(v18);</span></div><div class='line dim'><span style="color: #F8F8F2">      </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( copy_username_buf )</span></div><div class='line dim'><span style="color: #F8F8F2">      &#123;</span></div><div class='line highlight'><span style="color: #F8F8F2">        status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> ((</span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> (__fastcall </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(QWORD, QWORD, </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">))TSGlobalLsaFunctions-&gt;CopyFromClientBuffer)(</span></div><div class='line highlight'><span style="color: #F8F8F2">                </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">,</span></div><div class='line highlight'><span style="color: #F8F8F2">                username.Length,</span></div><div class='line highlight'><span style="color: #F8F8F2">                copy_username_buf,</span></div><div class='line highlight'><span style="color: #F8F8F2">                </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">buffer[username.Buffer]);</span></div><div class='line dim'><span style="color: #F8F8F2">        v21 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v19;</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line dim'><span style="color: #F8F8F2">          </span><span style="color: #F92672">goto</span><span style="color: #F8F8F2"> LABEL_17;</span></div><div class='line dim'><span style="color: #F8F8F2">        username.MaximumLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> username.Length;</span></div><div class='line dim'><span style="color: #F8F8F2">        copy_password_buf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">copy_username_buf[username.Length];</span></div><div class='line dim'><span style="color: #F8F8F2">        username.Buffer </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (UINT64)copy_username_buf;</span></div><div class='line highlight'><span style="color: #F8F8F2">        status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> ((</span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> (__fastcall </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(QWORD, QWORD, </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">))TSGlobalLsaFunctions-&gt;CopyFromClientBuffer)(</span></div><div class='line highlight'><span style="color: #F8F8F2">                </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">,</span></div><div class='line highlight'><span style="color: #F8F8F2">                password.Length,</span></div><div class='line highlight'><span style="color: #F8F8F2">                copy_password_buf,</span></div><div class='line highlight'><span style="color: #F8F8F2">                </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">buffer[password.Buffer]);</span></div><div class='line dim'><span style="color: #F8F8F2">        v21 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v19;</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line dim'><span style="color: #F8F8F2">          </span><span style="color: #F92672">goto</span><span style="color: #F8F8F2"> LABEL_17;</span></div><div class='line dim'><span style="color: #F8F8F2">        password.Buffer </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (UINT64)copy_password_buf;</span></div><div class='line dim'><span style="color: #F8F8F2">        copy_domain_buf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">copy_password_buf[password.Length];</span></div><div class='line dim'><span style="color: #F8F8F2">        password.MaximumLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> password.Length;</span></div><div class='line highlight'><span style="color: #F8F8F2">        status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> ((</span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> (__fastcall </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(QWORD, QWORD, </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">))TSGlobalLsaFunctions-&gt;CopyFromClientBuffer)(</span></div><div class='line highlight'><span style="color: #F8F8F2">                </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">,</span></div><div class='line highlight'><span style="color: #F8F8F2">                domain.Length,</span></div><div class='line highlight'><span style="color: #F8F8F2">                copy_domain_buf,</span></div><div class='line highlight'><span style="color: #F8F8F2">                </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">buffer[domain.Buffer]);</span></div><div class='line dim'><span style="color: #F8F8F2">        v21 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v19;</span></div><div class='line highlight'><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span></div><div class='line highlight'><span style="color: #F8F8F2">          </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> (domain.MaximumLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> domain.Length,</span></div><div class='line highlight'><span style="color: #F8F8F2">              domain.Buffer </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (UINT64)copy_domain_buf,</span></div><div class='line highlight'><span style="color: #F8F8F2">              copy_cert_buf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2">)</span><span style="color: #F92672">&</span><span style="color: #F8F8F2">copy_domain_buf[domain.Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">7</span><span style="color: #F8F8F2">] </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">FFFFFFFFFFFFFFF8</span><span style="color: #F92672">uLL</span><span style="color: #F8F8F2">,</span></div><div class='line highlight'><span style="color: #F8F8F2">              status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> ((</span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> (__fastcall </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(QWORD, QWORD, </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">))TSGlobalLsaFunctions-&gt;CopyFromClientBuffer)(</span></div><div class='line highlight'><span style="color: #F8F8F2">                      </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">,</span></div><div class='line highlight'><span style="color: #F8F8F2">                      cert_len,</span></div><div class='line highlight'><span style="color: #F8F8F2">                      copy_cert_buf,</span></div><div class='line highlight'><span style="color: #F8F8F2">                      </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">buffer[cert_offset]),</span></div><div class='line highlight'><span style="color: #F8F8F2">              v21 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v19,</span></div><div class='line highlight'><span style="color: #F8F8F2">              v13 </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">) )</span></div><div class='line dim'><span style="color: #F8F8F2">        &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">LABEL_17:</span></div><div class='line dim'><span style="color: #F8F8F2">          ... </span><span style="color: #88846F">// Cleanup</span></div><div class='line dim'><span style="color: #F8F8F2">        &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">else</span></div><div class='line dim'><span style="color: #F8F8F2">        &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">          ... </span><span style="color: #88846F">// Variable assignments</span></div><div class='line dim'><span style="color: #F8F8F2">        &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">      &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">      </span><span style="color: #F92672">else</span></div><div class='line dim'><span style="color: #F8F8F2">      &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000009A</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">      &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">    &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">  &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> status;</span></div><div class='line dim'><span style="color: #F8F8F2">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1rg88rb">The <strong>Unicode string check</strong> ensures that the buffers’ data must contain an even number of bytes. Subsequent calls to the <code>CopyFromClientBuffer</code> LSA function will copy data from a Unicode structure buffer at a specific offset within the <code>pAuthData</code> buffer. This operation overwrites the original offset with a pointer to a buffer that contains the copied data. Overall, the logon buffer format should look like this:</p> <img src="buffer_format.png" width="500" style="display: block; margin-left: auto; margin-right: auto;"> <h3 id="reaching-the-vulnerable-function" data-svelte-h="svelte-15pdpew"><a href="#reaching-the-vulnerable-function">Reaching the vulnerable function</a></h3> <p data-svelte-h="svelte-bpct6a">Now, that a valid buffer is constructed, <code>TsInitCertCred</code> is called, and a new set of validations is performed.</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" c="true"><div class="language-id">c</div><div class='code-container'><code><div class='line dim'><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> __fastcall </span><span style="color: #A6E22E">TSInitCertCreds</span><span style="color: #F8F8F2">(</span></div><div class='line dim'><span style="color: #F8F8F2">        PCCERT_CONTEXT </span><span style="color: #FD971F">pCert</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">username</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">password</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">domain</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">certData</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">certLen</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">        TS_PRIMARY_CREDENTIAL </span><span style="color: #F92672">**</span><span style="color: #FD971F">a7</span><span style="color: #F8F8F2">)</span></div><div class='line dim'><span style="color: #F8F8F2">&#123;</span></div><div class='line dim'><span style="color: #F8F8F2">  </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> _certLen;</span></div><div class='line dim'><span style="color: #F8F8F2">  </span><span style="color: #66D9EF">size_t</span><span style="color: #F8F8F2"> __certLen;</span></div><div class='line dim'><span style="color: #F8F8F2">  ... </span><span style="color: #88846F">// Other variables declaration</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">  status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> TSGlobalLsaFunctions-&gt;</span><span style="color: #A6E22E">ImpersonateClient</span><span style="color: #F8F8F2">();</span></div><div class='line dim'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line dim'><span style="color: #F8F8F2">  &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">    v12 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)</span><span style="color: #A6E22E">TSAllocate</span><span style="color: #F8F8F2">(</span><span style="color: #F92672">0x</span><span style="color: #AE81FF">E8</span><span style="color: #F92672">uLL</span><span style="color: #F8F8F2">);</span></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line dim'><span style="color: #F8F8F2">    v14 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> certData;</span></div><div class='line highlight'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( certData </span><span style="color: #F92672">&&</span><span style="color: #F8F8F2"> (_certLen </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> certLen) </span><span style="color: #F92672">!=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">      status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSGetCspDetailFromCspData</span><span style="color: #F8F8F2">(certLen, certData, (TS_CSPDATA_DETAIL </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(v12 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">50</span><span style="color: #F8F8F2">));</span></div><div class='line dim'><span style="color: #F8F8F2">      ... </span><span style="color: #88846F">// Cleanup on error</span></div><div class='line dim'><span style="color: #F8F8F2">    &#125;</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSDuplicateStringEx</span><span style="color: #F8F8F2">((UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">24</span><span style="color: #F8F8F2">), username, v16);</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line dim'><span style="color: #F8F8F2">    &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">      status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSDuplicateStringEx</span><span style="color: #F8F8F2">((UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">8</span><span style="color: #F8F8F2">), domain, v19);</span></div><div class='line dim'><span style="color: #F8F8F2">      </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line dim'><span style="color: #F8F8F2">      &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">        status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSDuplicatePassword</span><span style="color: #F8F8F2">((UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">40</span><span style="color: #F8F8F2">), password);</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line dim'><span style="color: #F8F8F2">        &#123;</span></div><div class='line dim'><span style="color: #F8F8F2">          </span><span style="color: #A6E22E">LODWORD</span><span style="color: #F8F8F2">(__certLen) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> _certLen;</span></div><div class='line highlight'><span style="color: #F8F8F2">          status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSCreateKerbCertLogonBuffer</span><span style="color: #F8F8F2">(</span></div><div class='line highlight'><span style="color: #F8F8F2">                     (UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">40</span><span style="color: #F8F8F2">),</span></div><div class='line highlight'><span style="color: #F8F8F2">                     (UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">8</span><span style="color: #F8F8F2">),</span></div><div class='line highlight'><span style="color: #F8F8F2">                     (UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">24</span><span style="color: #F8F8F2">),</span></div><div class='line highlight'><span style="color: #F8F8F2">                     v14,</span></div><div class='line highlight'><span style="color: #F8F8F2">                     __certLen,</span></div><div class='line highlight'><span style="color: #F8F8F2">                     (</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">**</span><span style="color: #F8F8F2">)v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">19</span><span style="color: #F8F8F2">,</span></div><div class='line highlight'><span style="color: #F8F8F2">                     (</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">40</span><span style="color: #F8F8F2">);</span></div><div class='line dim'><span style="color: #F8F8F2">          ... </span><span style="color: #88846F">// Cleanup on error</span></div><div class='line dim'><span style="color: #F8F8F2">        &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">      &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">    &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">goto</span><span style="color: #F8F8F2"> LABEL_7;</span></div><div class='line dim'><span style="color: #F8F8F2">  &#125;</span></div><div class='line dim'><span style="color: #F8F8F2">LABEL_9:</span></div><div class='line dim'><span style="color: #F8F8F2">  ... </span><span style="color: #88846F">// Cleanup</span></div><div class='line dim'><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> status;</span></div><div class='line dim'><span style="color: #F8F8F2">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1ey2e5d">These validations ensure that the certificate data adheres to the Windows-specific certificate format known as <strong>CSP (Cryptographic Service Provider)</strong>. This format is composed of two parts: a <strong>header</strong> and a <strong>body</strong>(CSP data). In this context, <strong>CSP data</strong> refers to the information within the certificate that identifies and links it to its corresponding private key provider.</p> <h4 id="crafting-a-valid-csp-buffer" data-svelte-h="svelte-stf7wl"><a href="#crafting-a-valid-csp-buffer">Crafting a valid CSP buffer</a></h4> <p data-svelte-h="svelte-1m0i1ox">The <code>TSGetCspDetailFromCspData</code> function first verifies that the CSP buffer is at least 0x30 bytes in size, 0x28 bytes for the header(10 DWORDs) + 1 padding DWORD + 1 <strong>Data Area</strong> DWORD.</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" c="true"><div class="language-id">c</div><div class='code-container'><code><div class='line'><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> __fastcall </span><span style="color: #A6E22E">TSGetCspDetailFromCspData</span><span style="color: #F8F8F2">(</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">certLen</span><span style="color: #F8F8F2">,</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">certData</span><span style="color: #F8F8F2">,</span></div><div class='line'><span style="color: #F8F8F2">        TS_CSPDATA_DETAIL </span><span style="color: #F92672">*</span><span style="color: #FD971F">a3</span><span style="color: #F8F8F2">)</span></div><div class='line'><span style="color: #F8F8F2">&#123;</span></div><div class='line'><span style="color: #F8F8F2">  ... </span><span style="color: #88846F">// Variables declaration</span></div><div class='line'></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( </span><span style="color: #F92672">!</span><span style="color: #F8F8F2">certData </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> certLen </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">30</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">!</span><span style="color: #F8F8F2">a3 )</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000000D</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #A6E22E">memset_0</span><span style="color: #F8F8F2">(a3, </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">48</span><span style="color: #F92672">uLL</span><span style="color: #F8F8F2">);</span></div><div class='line'><span style="color: #F8F8F2">  status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSRelocateCspString</span><span style="color: #F8F8F2">(</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">((DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">6</span><span style="color: #F8F8F2">), (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData, certLen, </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v13, </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">);</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line'><span style="color: #F8F8F2">  &#123;</span></div><div class='line'><span style="color: #F8F8F2">    status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSRelocateCspString</span><span style="color: #F8F8F2">(</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">((DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">7</span><span style="color: #F8F8F2">), (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData, certLen, </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v10, </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">);</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line'><span style="color: #F8F8F2">    &#123;</span></div><div class='line'><span style="color: #F8F8F2">      status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSRelocateCspString</span><span style="color: #F8F8F2">(</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">((DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">8</span><span style="color: #F8F8F2">), (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData, certLen, </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v11, </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">);</span></div><div class='line'><span style="color: #F8F8F2">      </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( status </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line'><span style="color: #F8F8F2">      &#123;</span></div><div class='line'><span style="color: #F8F8F2">        _status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSRelocateCspString</span><span style="color: #F8F8F2">(</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">((DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">9</span><span style="color: #F8F8F2">), (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData, certLen, </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v12, </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">);</span></div><div class='line'><span style="color: #F8F8F2">        v3 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v12;</span></div><div class='line'><span style="color: #F8F8F2">        status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> _status;</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( _status </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> )</span></div><div class='line'><span style="color: #F8F8F2">          status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSBuildCspDetail</span><span style="color: #F8F8F2">(v13, v10, v11, v12, </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">((DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)certData </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">5</span><span style="color: #F8F8F2">), a3);</span></div><div class='line'><span style="color: #F8F8F2">      &#125;</span></div><div class='line'><span style="color: #F8F8F2">    &#125;</span></div><div class='line'><span style="color: #F8F8F2">  &#125;</span></div><div class='line'><span style="color: #F8F8F2">  ... </span><span style="color: #88846F">// Cleanup</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> status;</span></div><div class='line'><span style="color: #F8F8F2">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-fcmeo0">After this initial check, the function delegates further validation to <code>TSRelocateCspString</code>. This includes:</p> <ul data-svelte-h="svelte-oa9hdf"><li>Checking the <strong>providerName</strong> value (located at <strong>header[5]</strong>).</li> <li>Validating the offset from which the string starts within the <strong>Data Area</strong> (located at <strong>header[6]</strong>).</li></ul> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" c="true"><div class="language-id">c</div><div class='code-container'><code><div class='line'><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> __fastcall </span><span style="color: #A6E22E">TSRelocateCspString</span><span style="color: #F8F8F2">(</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">a1</span><span style="color: #F8F8F2">,               </span><span style="color: #88846F">// Offset into the input buffer</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">a2</span><span style="color: #F8F8F2">,             </span><span style="color: #88846F">// Pointer to a buffer (CSP blob)</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">a3</span><span style="color: #F8F8F2">,      </span><span style="color: #88846F">// Total size of that buffer</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">short</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">**</span><span style="color: #FD971F">a4</span><span style="color: #F8F8F2">,  </span><span style="color: #88846F">// [out] Receives pointer to newly allocated wide string</span></div><div class='line'><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">a5</span><span style="color: #F8F8F2">)               </span><span style="color: #88846F">// Flag</span></div><div class='line'><span style="color: #F8F8F2">&#123;</span></div><div class='line'><span style="color: #F8F8F2">  ... </span><span style="color: #88846F">// Variables declaration</span></div><div class='line'></div><div class='line'><span style="color: #F8F8F2">  v5 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( </span><span style="color: #F92672">!</span><span style="color: #F8F8F2">a4 </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">!</span><span style="color: #F8F8F2">a2 </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> a3 </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">30</span><span style="color: #F8F8F2"> )</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000000D</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">a4 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( </span><span style="color: #F92672">!</span><span style="color: #F8F8F2">a1 </span><span style="color: #F92672">&&</span><span style="color: #F8F8F2"> a5 )</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  v8 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2"> a1;    </span><span style="color: #88846F">// Offset in bytes</span></div><div class='line'><span style="color: #F8F8F2">  v9 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> a2 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">40</span><span style="color: #F8F8F2">;   </span><span style="color: #88846F">// Data/String area</span></div><div class='line'><span style="color: #F8F8F2">  v10 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> a3 </span><span style="color: #F92672">-</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">40</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( v8 </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> v10 )</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000000D</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  v11 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v9[v8];</span></div><div class='line'><span style="color: #F8F8F2">  v12 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">v9[v10];</span></div><div class='line'><span style="color: #F8F8F2">  v13 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v11;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( v11 </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> v12 )</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000000D</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">while</span><span style="color: #F8F8F2"> ( </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2"> )</span></div><div class='line'><span style="color: #F8F8F2">  &#123;</span></div><div class='line'><span style="color: #F8F8F2">    v14 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">v13;</span></div><div class='line'><span style="color: #F8F8F2">    v5 </span><span style="color: #F92672">+=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    v15 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v13 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( </span><span style="color: #F92672">!</span><span style="color: #F8F8F2">v14 </span><span style="color: #F92672">&&</span><span style="color: #F8F8F2"> v15 </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> v12 </span><span style="color: #F92672">&&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">!*</span><span style="color: #F8F8F2">v15 )</span></div><div class='line'><span style="color: #F8F8F2">      </span><span style="color: #F92672">break</span><span style="color: #F8F8F2">;   </span><span style="color: #88846F">// Found double-null terminator =&gt; End of wide string</span></div><div class='line'><span style="color: #F8F8F2">    v13 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v15 </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( v13 </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> v12 )</span></div><div class='line'><span style="color: #F8F8F2">      </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000000D</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  &#125;</span></div><div class='line'><span style="color: #F8F8F2">  v16 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v5;</span></div><div class='line'><span style="color: #F8F8F2">  v17 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">short</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)</span><span style="color: #A6E22E">TSAllocate</span><span style="color: #F8F8F2">(v5);</span></div><div class='line'><span style="color: #F8F8F2">  v18 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v17;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> ( v17 )</span></div><div class='line'><span style="color: #F8F8F2">  &#123;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(v17, v11, v16);</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">a4 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> v18;</span></div><div class='line'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">  &#125;</span></div><div class='line'><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000009A</span><span style="color: #F8F8F2">;</span></div><div class='line'><span style="color: #F8F8F2">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1bm945n"><strong>Note</strong>: There are no restrictions on the length of the <strong>Data Area</strong> section!</p> <img src="buffer_format_csp.png" width="200" style="display: block; margin-left: auto; margin-right: auto;"> <h3 id="triggering-the-bug" data-svelte-h="svelte-1iqvjrz"><a href="#triggering-the-bug">Triggering the bug</a></h3> <p data-svelte-h="svelte-1qfc8q4">The buffer format is finalized and passed to the vulnerable function <code>TSCreateKerbCertLogonBuffer</code>.</p> <!-- HTML_TAG_START --><pre class="shiki monokai" style="background-color: #272822; color: #F8F8F2" c="true"><div class="language-id">c</div><div class='code-container'><code><div class='line dim'><span style="color: #66D9EF">int64_t</span><span style="color: #F8F8F2"> __fastcall </span><span style="color: #A6E22E">TSCreateKerbCertLogonBuffer</span><span style="color: #F8F8F2">(</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">struct</span><span style="color: #F8F8F2"> UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">password</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">struct</span><span style="color: #F8F8F2"> UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">domain</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">struct</span><span style="color: #F8F8F2"> UNICODE_STRING </span><span style="color: #F92672">*</span><span style="color: #FD971F">username</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">certData</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">size_t</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">certLen</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">**</span><span style="color: #FD971F">a6</span><span style="color: #F8F8F2">,</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #FD971F">a7</span><span style="color: #F8F8F2">)</span></div><div class='line dim'><span style="color: #F8F8F2">&#123;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> totalLength;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> __totalLength;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">int</span><span style="color: #F8F8F2"> _Size;</span></div><div class='line dim'><span style="color: #F8F8F2">    ... </span><span style="color: #88846F">// Other variables declaration</span></div><div class='line'></div><div class='line highlight'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Calculate total length (aligned)</span></div><div class='line highlight'><span style="color: #F8F8F2">    totalLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (domain-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> password-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> username-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">93</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">FFFFFFF8</span><span style="color: #F8F8F2">;</span></div><div class='line highlight'><span style="color: #F8F8F2">    __totalLength </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> totalLength </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> certLen;</span></div><div class='line dim'><span style="color: #F8F8F2">    _Size </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> certLen;</span></div><div class='line'></div><div class='line highlight'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Allocate memory</span></div><div class='line highlight'><span style="color: #F8F8F2">    vulnBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">TSAllocate</span><span style="color: #F8F8F2">(__totalLength);</span></div><div class='line dim'><span style="color: #F8F8F2">    _vulnBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> vulnBuf;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (</span><span style="color: #F92672">!</span><span style="color: #F8F8F2">vulnBuf)</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">C000009A</span><span style="color: #F8F8F2">;   </span><span style="color: #88846F">// STATUS_INSUFFICIENT_RESOURCES</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Fill in header</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)vulnBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">13</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    currentPtr   </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">80</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    passwordBuf  </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">void</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">80</span><span style="color: #F8F8F2">);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Password</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">40</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> password-&gt;Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    length </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> password-&gt;Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(QWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">48</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">80</span><span style="color: #F92672">LL</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">42</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(passwordBuf, password-&gt;Buffer, password-&gt;Length);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Domain</span></div><div class='line dim'><span style="color: #F8F8F2">    domainBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">short</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">42</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> currentPtr);</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">8</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> domain-&gt;Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">10</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> domain-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(QWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">16</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">domainBuf[</span><span style="color: #F92672">-</span><span style="color: #F8F8F2">_vulnBuf];</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(domainBuf, domain-&gt;Buffer, domain-&gt;Length);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Username</span></div><div class='line dim'><span style="color: #F8F8F2">    usernameBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">domainBuf[</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">short</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">10</span><span style="color: #F8F8F2">)];</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">24</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> username-&gt;Length;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(WORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">26</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> username-&gt;Length </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(QWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">32</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">usernameBuf[</span><span style="color: #F92672">-</span><span style="color: #F8F8F2">_vulnBuf];</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(usernameBuf, username-&gt;Buffer, username-&gt;Length);</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #88846F">// Certificate</span></div><div class='line dim'><span style="color: #F8F8F2">    certBuf </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">char</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(</span></div><div class='line dim'><span style="color: #F8F8F2">        (</span><span style="color: #66D9EF">uint64_t</span><span style="color: #F8F8F2">)</span><span style="color: #F92672">&</span><span style="color: #F8F8F2">usernameBuf[</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">unsigned</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">short</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">26</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">7</span><span style="color: #F8F8F2">]</span></div><div class='line dim'><span style="color: #F8F8F2">        </span><span style="color: #F92672">&</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">0x</span><span style="color: #AE81FF">FFFFFFFFFFFFFFF8</span><span style="color: #F92672">ULL</span></div><div class='line dim'><span style="color: #F8F8F2">    );</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(DWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">60</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> _Size;</span></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">(QWORD </span><span style="color: #F92672">*</span><span style="color: #F8F8F2">)(_vulnBuf </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">64</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&</span><span style="color: #F8F8F2">certBuf[</span><span style="color: #F92672">-</span><span style="color: #F8F8F2">_vulnBuf];</span></div><div class='line highlight'><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">memcpy_0</span><span style="color: #F8F8F2">(certBuf, certData, _Size); </span><span style="color: #88846F">// Overflow occurs here</span></div><div class='line dim'><span style="color: #F8F8F2">    ...</span></div><div class='line'></div><div class='line dim'><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> status;</span></div><div class='line dim'><span style="color: #F8F8F2">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1mkmhk2">The heap object size is calculated as the sum of the lengths of the <strong>username</strong>, <strong>domain</strong>, <strong>password</strong>, and <strong>certificate</strong>, plus a fixed overhead of <strong>93 bytes</strong>. Because the certificate length can be any 32-bit (DWORD) value, the total size calculation can overflow.</p> <p data-svelte-h="svelte-180vc6l">The resulting incorrect size is then used to allocate a heap object. When the code later copies the certificate bytes into this undersized buffer, an overflow occurs—approximately 4 GB of data is written past the end of the allocated chunk.</p> <p><picture><source srcset="/blog/_app/immutable/assets/overflow.B-Hy22_m.avif 736w" type="image/avif"> <img alt="/demystifying-CVE-2025-47987/overflow.png" class="rounded-lg my-2" decoding="async" loading="lazy" src="/demystifying-CVE-2025-47987/overflow.png"></picture></p> <p data-svelte-h="svelte-svfwjm">This overwrites adjacent heap structures and accesses unmapped memory, leading to a crash of the privileged <code>lsass.exe</code> process.</p> <p data-svelte-h="svelte-174s55s"><a href="https://github.com/Kryptoenix/CVE-2025-47987_PoC/" rel="nofollow noopener noreferrer external" target="_blank">PoC code here (Win11 23H2)</a></p> <video controls src="poc.mp4" title="Title"></video> <h2 id="exploitation-ideas" data-svelte-h="svelte-1cilq0w"><a href="#exploitation-ideas">Exploitation Ideas</a></h2> <p data-svelte-h="svelte-18f0y70">Even though Microsoft classifies this CVE with an exploitability assessment of <strong><em>“Exploitation More Likely”</em></strong>, the crash caused by the overflow appears difficult to avoid because of the large number of bytes involved. It is theoretically possible that pointers could be overwritten before integrity checks are triggered, which might open a path to code execution that causes persistence across the forced reboot. However, modern security mitigations significantly reduce the likelihood of such a scenario. Therefore, the exploitation stage requires a better expertise in:</p> <ul data-svelte-h="svelte-1e9bq3x"><li><p>Windows heap internals</p> <ul><li>LFH, safe unlinking &amp; pointer decoding, guard pages, delayed free</li></ul></li> <li><p>Mitigations in user-mode on Windows 11</p> <ul><li>Heap isolation, pointer encoding, CFG, CET, MemGC</li></ul></li></ul> <h2 id="conclusion" data-svelte-h="svelte-kmpttn"><a href="#conclusion">Conclusion</a></h2> <p data-svelte-h="svelte-f4flx5">This concludes my analysis. Each piece of the puzzle has helped build a clearer picture of the vulnerability.  Hopefully, this sparks someone’s curiosity to dig deeper and perhaps even solve the exploitation mystery by crafting a working LPE proof-of-concept:). Either way, remember to stay curious and vigilant. Until next time — crash <code>lsass.exe</code>!</p> <h2 id="references" data-svelte-h="svelte-m6t0hm"><a href="#references">References</a></h2> <p data-svelte-h="svelte-wlk0jn"><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-47987" rel="nofollow noopener noreferrer external" target="_blank">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-47987</a></p> <p data-svelte-h="svelte-1ap8ze5"><a href="https://ldapwiki.com/wiki/Wiki.jsp?page=Windows%20Client%20Authentication%20Architecture" rel="nofollow noopener noreferrer external" target="_blank">https://ldapwiki.com/wiki/Wiki.jsp?page=Windows%20Client%20Authentication%20Architecture</a></p> <p data-svelte-h="svelte-1a6gw2a"><a href="https://learn.microsoft.com/en-us/windows/win32/secauthn/acquirecredentialshandle--general" rel="nofollow noopener noreferrer external" target="_blank">https://learn.microsoft.com/en-us/windows/win32/secauthn/acquirecredentialshandle–general</a></p></main> <div class="divider mt-4 mb-0"></div> <div><a href="/?tags=CVE-2025-47987" class="btn btn-sm btn-ghost normal-case mt-2 mr-2 p-category">#CVE-2025-47987 </a><a href="/?tags=Reverse Engineering" class="btn btn-sm btn-ghost normal-case mt-2 mr-2 p-category">#Reverse Engineering </a><a href="/?tags=Windows" class="btn btn-sm btn-ghost normal-case mt-2 mr-2 p-category">#Windows </a></div></div>  </article> <footer class="footer footer-center bg-base-300 text-base-content shadow-inner p-8 md:rounded-box sticky bottom-0 z-0 md:static " id="footer"><div class="prose"><p><a href="/blog/atom.xml" rel="noopener noreferrer external" target="_blank">Feed</a> <span class="mr-1" data-svelte-h="svelte-lk4btp">·</span><a href="/blog/sitemap.xml" rel="noopener noreferrer external" target="_blank">Sitemap</a>  <br>
      Copyright © 2025 Kryptoenix <br>
      Powered by
      <a class="tooltip tooltip-secondary hover:text-secondary" data-tip="🌸 [Polaris] - Based on MDsveX &amp; SvelteKit 🌸" href="https://github.com/importantimport/urara" rel="noopener noreferrer external" target="_blank" data-svelte-h="svelte-vjman6">Urara</a> </p></div></footer></div></div></div> 
			<script type="application/json" data-sveltekit-fetched data-url="/blog/posts.json">{"status":200,"statusText":"","headers":{},"body":"[{\"title\":\"About\",\"flags\":[\"unlisted\"],\"created\":\"2025-08-28T17:20:38.084Z\",\"updated\":\"2025-08-28T17:20:38.084Z\",\"images\":[],\"tags\":[],\"slug\":\"/about/+page.svelte.md\",\"path\":\"/blog/about\",\"toc\":[{\"depth\":2,\"slug\":\"hello-world\",\"title\":\"Hello World\"}],\"html\":\"\",\"type\":\"article\"},{\"title\":\"Demystifying CVE-2025-47987\",\"image\":\"/demystifying-CVE-2025-47987/image-cve1.png\",\"created\":\"2025-07-10T00:00:00.000Z\",\"updated\":\"2025-07-10T00:00:00.000Z\",\"tags\":[\"CVE-2025-47987\",\"Reverse Engineering\",\"Windows\"],\"images\":[],\"slug\":\"/demystifying-CVE-2025-47987/+page.svelte.md\",\"path\":\"/blog/demystifying-CVE-2025-47987\",\"toc\":[{\"depth\":2,\"slug\":\"client-authentication-architecture\",\"title\":\"Client Authentication Architecture\"},{\"depth\":2,\"slug\":\"root-cause\",\"title\":\"Root Cause\"},{\"depth\":2,\"slug\":\"building-a-poc-crash\",\"title\":\"Building a PoC Crash\"},{\"depth\":3,\"slug\":\"reaching-tsinitcertcreds\",\"title\":\"Reaching TSInitCertCreds()\"},{\"depth\":4,\"slug\":\"crafting-a-valid-packed-kerbcertlogonbuffer\",\"title\":\"Crafting a valid packed KerbCertLogonBuffer\"},{\"depth\":3,\"slug\":\"reaching-the-vulnerable-function\",\"title\":\"Reaching the vulnerable function\"},{\"depth\":4,\"slug\":\"crafting-a-valid-csp-buffer\",\"title\":\"Crafting a valid CSP buffer\"},{\"depth\":3,\"slug\":\"triggering-the-bug\",\"title\":\"Triggering the bug\"},{\"depth\":2,\"slug\":\"exploitation-ideas\",\"title\":\"Exploitation Ideas\"},{\"depth\":2,\"slug\":\"conclusion\",\"title\":\"Conclusion\"},{\"depth\":2,\"slug\":\"references\",\"title\":\"References\"}],\"html\":\"\",\"type\":\"article\"},{\"title\":\"Hunting in the wild - XWorm new variant\",\"image\":\"/xworm-malware-analysis/xworm-p.png\",\"alt\":\"Urara\",\"created\":\"2024-02-17T00:00:00.000Z\",\"updated\":\"2024-02-17T00:00:00.000Z\",\"tags\":[\"Malware Analysis\",\"XWorm\"],\"images\":[],\"slug\":\"/xworm-malware-analysis/+page.svelte.md\",\"path\":\"/blog/xworm-malware-analysis\",\"toc\":[{\"depth\":2,\"slug\":\"introduction\",\"title\":\"Introduction\"},{\"depth\":2,\"slug\":\"first-sign-of-malicious-code\",\"title\":\"First sign of malicious code\"},{\"depth\":2,\"slug\":\"new-language-old-friend\",\"title\":\"New language, old friend\"},{\"depth\":2,\"slug\":\"decompiling-the-culprit\",\"title\":\"Decompiling the culprit\"},{\"depth\":2,\"slug\":\"searching-for-keys\",\"title\":\"Searching for keys?\"},{\"depth\":2,\"slug\":\"conclusion\",\"title\":\"Conclusion\"}],\"html\":\"\",\"type\":\"article\"}]"}</script>
			<script>
				{
					__sveltekit_5tv1uj = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.5BFxfmEv.js"),
						import("../_app/immutable/entry/app.CWN9j8t8.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 4],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
  </body>
</html>
